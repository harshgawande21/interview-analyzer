{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="glass-card p-5 fade-in">
            <h2 class="text-white mb-4 text-center">
                <i class="fas fa-building me-2"></i>Organization Dashboard
            </h2>
            
            <div id="upload-section">
                <div class="question-card">
                    <h4 class="text-white mb-3">
                        <i class="fas fa-file-pdf me-2"></i>Upload Interview Questions
                    </h4>
                    <p class="text-white-custom mb-3">
                        Upload a PDF file containing your interview questions. Each question should end with a question mark (?).
                    </p>
                    
                    <form id="upload-form" enctype="multipart/form-data">
                        <div class="mb-3">
                            <input type="file" class="form-control form-control-glass" id="pdf-file" 
                                   accept=".pdf" required>
                        </div>
                        <button type="submit" class="btn btn-glass btn-lg w-100">
                            <i class="fas fa-upload me-2"></i>Upload Questions
                        </button>
                    </form>
                </div>
                
                <div id="upload-status" class="mt-3" style="display: none;">
                    <div class="alert alert-info glass-card">
                        <i class="fas fa-spinner fa-spin me-2"></i>Processing PDF...
                    </div>
                </div>
            </div>
            
            <div id="questions-preview" style="display: none;">
                <div class="question-card">
                    <h4 class="text-white mb-3">
                        <i class="fas fa-list me-2"></i>Extracted Questions
                    </h4>
                    <div id="questions-list" class="mb-3"></div>
                    
                    <div class="d-grid gap-2">
                        <button id="start-interview-btn" class="btn btn-glass btn-lg">
                            <i class="fas fa-play me-2"></i>Start Interview Session
                        </button>
                        <button id="upload-new-btn" class="btn btn-outline-light">
                            <i class="fas fa-redo me-2"></i>Upload New Questions
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="interview-link-section" style="display: none;">
                <div class="question-card text-center">
                    <h4 class="text-white mb-3">
                        <i class="fas fa-link me-2"></i>Interview Session Ready
                    </h4>
                    <p class="text-white-custom mb-3">
                        Share this link with candidates to start their interview:
                    </p>
                    
                    <div class="input-group mb-3">
                        <input type="text" id="interview-link" class="form-control form-control-glass" readonly>
                        <button class="btn btn-glass" type="button" id="copy-link-btn">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <button id="view-results-btn" class="btn btn-glass w-100">
                                <i class="fas fa-chart-bar me-2"></i>View Results
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button id="new-session-btn" class="btn btn-outline-light w-100">
                                <i class="fas fa-plus me-2"></i>New Session
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="results-section" style="display: none;">
                <div class="question-card">
                    <h4 class="text-white mb-3">
                        <i class="fas fa-chart-pie me-2"></i>Interview Results
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="emotion-chart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div id="answers-summary" class="text-white-custom">
                                <!-- Answers will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentOrgId = null;
let socket = null;

document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('pdf-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a PDF file');
        return;
    }
    
    const formData = new FormData();
    formData.append('pdf_file', file);
    
    document.getElementById('upload-status').style.display = 'block';
    
    try {
        const response = await fetch('/upload_questions', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        document.getElementById('upload-status').style.display = 'none';
        
        if (result.success) {
            currentOrgId = result.org_id;
            displayQuestions(result.questions);
        } else {
            alert('Error: ' + result.message);
        }
    } catch (error) {
        document.getElementById('upload-status').style.display = 'none';
        alert('Error uploading file: ' + error.message);
    }
});

function displayQuestions(questions) {
    const questionsList = document.getElementById('questions-list');
    questionsList.innerHTML = '';
    
    questions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'mb-2 p-2 rounded';
        questionDiv.style.background = 'rgba(255, 255, 255, 0.1)';
        questionDiv.innerHTML = `
            <span class="text-white-custom">
                <strong>Q${index + 1}:</strong> ${question}
            </span>
        `;
        questionsList.appendChild(questionDiv);
    });
    
    document.getElementById('upload-section').style.display = 'none';
    document.getElementById('questions-preview').style.display = 'block';
}

document.getElementById('start-interview-btn').addEventListener('click', function() {
    if (currentOrgId) {
        const interviewLink = `${window.location.origin}/start_interview/${currentOrgId}`;
        document.getElementById('interview-link').value = interviewLink;
        
        document.getElementById('questions-preview').style.display = 'none';
        document.getElementById('interview-link-section').style.display = 'block';
        
        // Initialize socket connection for organization
        initializeSocket();
    }
});

document.getElementById('copy-link-btn').addEventListener('click', function() {
    const linkInput = document.getElementById('interview-link');
    linkInput.select();
    document.execCommand('copy');
    
    const btn = document.getElementById('copy-link-btn');
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i>';
    setTimeout(() => {
        btn.innerHTML = originalHTML;
    }, 2000);
});

document.getElementById('upload-new-btn').addEventListener('click', function() {
    document.getElementById('questions-preview').style.display = 'none';
    document.getElementById('upload-section').style.display = 'block';
    document.getElementById('pdf-file').value = '';
});

document.getElementById('new-session-btn').addEventListener('click', function() {
    location.reload();
});

document.getElementById('view-results-btn').addEventListener('click', function() {
    document.getElementById('interview-link-section').style.display = 'none';
    document.getElementById('results-section').style.display = 'block';
    
    if (socket) {
        socket.emit('get_results');
    }
});

function initializeSocket() {
    socket = io();
    
    socket.emit('join_interview', {
        user_type: 'organization',
        org_id: currentOrgId
    });
    
    socket.on('interview_results', function(data) {
        displayResults(data);
    });
}

function displayResults(data) {
    // Create emotion pie chart
    const ctx = document.getElementById('emotion-chart').getContext('2d');
    
    const emotionLabels = Object.keys(data.emotion_stats);
    const emotionData = Object.values(data.emotion_stats);
    
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: emotionLabels,
            datasets: [{
                data: emotionData,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: {
                        color: 'white'
                    }
                }
            }
        }
    });
    
    // Display answers summary
    const answersDiv = document.getElementById('answers-summary');
    answersDiv.innerHTML = '<h5>Candidate Answers:</h5>';
    
    data.answers.forEach((answer, index) => {
        const answerDiv = document.createElement('div');
        answerDiv.className = 'mb-3 p-2 rounded';
        answerDiv.style.background = 'rgba(255, 255, 255, 0.1)';
        answerDiv.innerHTML = `
            <strong>Answer ${index + 1}:</strong><br>
            <span class="small">${answer.answer}</span>
        `;
        answersDiv.appendChild(answerDiv);
    });
}
</script>
{% endblock %}